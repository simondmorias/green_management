# F3-T1 - Live Intent Highlighting - Entity Artifact Generation Script

## Document Control
**Feature Name & Link:** [Live Intent Highlighting for Conversational Interface](../feature.md)
**Plan Name & Link:** [Implementation Plan](../plan.md)
**Date Created:** September 1, 2025  
**Status:** Not Started

---

## Overview
Create a manual Python script in the Gain repository that connects to Databricks, extracts entity data from the master product hierarchy table, and generates JSON artifacts for entity recognition. This script will be run manually by developers to refresh entity data.

---

## Task Requirements

### Task1: Manual Entity Artifact Generation Script
**Status:** Not Started

**Description:**
Implement a Python script in the Gain repository's `devtools/` directory that uses the Databricks SDK to connect to the `rgm_poc.chocolate.master_product_hierarchy` table and generates optimized JSON artifacts for entity matching. The script produces two outputs: gazetteer.json (entity lists by type) and aliases.jsonl (entity name variations), and optionally pushes data to Redis for caching.

**Technical Details:**
- Files to create/modify:
  - `/gain/devtools/generate_entity_artifacts.py` - Main generation script
  - `/gain/devtools/requirements.txt` - Script dependencies
  - `/gain/devtools/.env.example` - Environment variables template
  - `/gain/devtools/README.md` - Documentation for running the script
  - `/gain/apps/api/app/data/artifacts/gazetteer.json` - Output artifact (entity lists)
  - `/gain/apps/api/app/data/artifacts/aliases.jsonl` - Output artifact (entity mappings)

- Key implementation points:
  - Use Databricks SDK to connect to `rgm_poc.chocolate.master_product_hierarchy`
  - Query hierarchy data understanding the structure:
    - Brand hierarchy: Manufacturer (level 0) → Brand (level 1)
    - Category hierarchy: Category (level 0) → Needstate (level 1) → Segment (level 2) → Subsegment (level 3)
  - Build gazetteer structure with entities grouped by type:
    - manufacturers: List of manufacturer entities
    - brands: List of brand entities
    - categories: List of category entities
    - products: Combined list of needstates, segments, subsegments
  - Generate common aliases for each entity:
    - Plurals (e.g., "Snickers" → "Snickers bars")
    - Common abbreviations (e.g., "Manufacturing" → "Mfg")
    - Case variations (maintain original for display)
    - Common misspellings based on edit distance
  - Include entity metadata:
    - id: product_hierarchy_key from table
    - type: entity type (manufacturer, brand, category, product)
    - display_name: original description from table
    - hierarchy_path: full path in hierarchy
    - parent_id: parent_key from table
  - Optimize JSON structure for fast loading (<10MB total)
  - Add optional Redis push functionality:
    - Connect to local Redis instance
    - Push gazetteer and aliases with 24-hour TTL
    - Use keys: `entity:gazetteer` and `entity:aliases`
  - Include progress logging and error handling
  - Support dry-run mode for testing

**Acceptance Criteria:**
- [ ] Script successfully connects to Databricks using SDK
- [ ] Extracts all entities from master_product_hierarchy table
- [ ] Gazetteer.json contains entities organized by type (manufacturers, brands, categories, products)
- [ ] Aliases.jsonl contains at least 3x entities with variations
- [ ] Each entity includes required metadata (id, type, display_name, hierarchy_path)
- [ ] Script completes in under 2 minutes
- [ ] Output files are valid JSON/JSONL format
- [ ] Total artifact size < 10MB
- [ ] Optional Redis push works when enabled
- [ ] Clear documentation on how to run the script
- [ ] Environment variables properly configured
- [ ] Error handling for connection failures
- [ ] Dry-run mode for testing without output

## Developer Completion Details

*To be completed by the developer at the end of the task implementation*

### Metadata

- Repo Name: Gain
- Branch Name: [Branch Name]

### Summary of Changes

**Overview**
*Write 500 words to summarise what was done and any issues discovered*

**Testing Notes:**
*Specific test scenarios to verify*

**Definition of Done:**
- [ ] Code implemented and peer reviewed
- [ ] Tests written and passing
- [ ] Documentation updated
- [ ] No linting errors
- [ ] Ready for PR and Approval