# F3-T7 - Live Intent Highlighting - Scheduled Artifact Updates

## Document Control
**Feature Name & Link:** [Live Intent Highlighting for Conversational Interface](../feature.md)
**Plan Name & Link:** [Implementation Plan](../plan.md)
**Date Created:** September 1, 2025  
**Status:** Not Started

---

## Overview
Implement Celery task for scheduled daily updates of entity artifacts from Databricks, with proper error handling and monitoring.

---

## Task Requirements

### Task1: Celery Task for Artifact Refresh
**Status:** Not Started

**Description:**
Create a Celery task that runs daily at 2 AM UTC to refresh entity artifacts from Databricks. The task should trigger the artifact generation pipeline, fetch the results, update Redis cache, and track execution metrics.

**Technical Details:**
- Files to create/modify:
  - `/gain/services/worker/tasks/entity_artifacts.py` - Celery task implementation
  - `/gain/services/worker/schedules.py` - Add daily schedule
  - `/gain/apps/api/app/routes/admin.py` - Manual trigger endpoint
  - `/gain/packages/persistence/models.py` - Add artifact_updates table
  - `/gain/packages/persistence/alembic/versions/xxx_add_artifact_updates.py` - Migration

- Key implementation points:
  - Schedule task for 2 AM UTC daily using Celery beat
  - Trigger Databricks job via API or SDK
  - Poll for job completion with timeout (30 minutes max)
  - Download generated artifacts from storage
  - Validate artifact structure and content
  - Update Redis cache atomically
  - Track execution metrics (duration, size, entity count)
  - Implement retry logic with exponential backoff
  - Send alerts on failure via existing monitoring

**Acceptance Criteria:**
- [ ] Task runs automatically at 2 AM UTC daily
- [ ] Databricks job triggered successfully
- [ ] Artifacts downloaded and validated
- [ ] Redis cache updated atomically (no partial updates)
- [ ] Execution metrics logged to database
- [ ] Failures retry up to 3 times
- [ ] Manual trigger endpoint works for admins
- [ ] Old artifacts backed up before update
- [ ] Task completes within 30 minutes

## Developer Completion Details

*To be completed by the developer at the end of the task implementation*

### Metadata

- Repo Name: Gain
- Branch Name: [Branch Name]

### Summary of Changes

**Overview**
*Write 500 words to summarise what was done and any issues discovered*

**Testing Notes:**
*Specific test scenarios to verify*

**Definition of Done:**
- [ ] Code implemented and peer reviewed
- [ ] Tests written and passing
- [ ] Documentation updated
- [ ] No linting errors
- [ ] Ready for PR and Approval